<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lezione 12.3 - CROSS JOIN e SELF JOIN</title>
    <link rel="stylesheet" href="/style.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Lezione 12.3 - CROSS JOIN e SELF JOIN</h1>
            <p>Prodotto cartesiano e join su se stessa</p>
        </div>

        <h2>1. CROSS JOIN</h2>
        
        <div class="teoria">
            <p><strong>CROSS JOIN</strong> restituisce il <strong>prodotto cartesiano</strong> di due tabelle, ovvero ogni riga della prima tabella viene combinata con ogni riga della seconda tabella. Se la tabella A ha 10 righe e la tabella B ha 5 righe, il risultato avrà 50 righe.</p>
            <p><strong>Attenzione:</strong> CROSS JOIN può generare risultati molto grandi! Usalo con cautela.</p>
        </div>

        <h3>1.1 Sintassi</h3>

        <div class="codice">
<pre>SELECT colonne
FROM tabella1
CROSS JOIN tabella2;

-- Oppure semplicemente:
SELECT colonne
FROM tabella1, tabella2;</pre>
        </div>

        <h3>1.2 Esempio CROSS JOIN</h3>

        <div class="codice">
<pre>-- Tabelle di esempio
CREATE TABLE taglie (
    id INT PRIMARY KEY AUTO_INCREMENT,
    nome VARCHAR(10)
);

CREATE TABLE colori (
    id INT PRIMARY KEY AUTO_INCREMENT,
    nome VARCHAR(20)
);

INSERT INTO taglie (nome) VALUES ('S'), ('M'), ('L'), ('XL');
INSERT INTO colori (nome) VALUES ('Rosso'), ('Blu'), ('Verde');

-- CROSS JOIN: tutte le combinazioni taglia-colore
SELECT t.nome AS taglia, c.nome AS colore
FROM taglie t
CROSS JOIN colori c
ORDER BY t.id, c.id;</pre>
        </div>

        <div class="anteprima">
            <p><strong>Risultato (4 taglie × 3 colori = 12 combinazioni):</strong></p>
            <pre>+--------+--------+
| taglia | colore |
+--------+--------+
| S      | Rosso  |
| S      | Blu    |
| S      | Verde  |
| M      | Rosso  |
| M      | Blu    |
| M      | Verde  |
| L      | Rosso  |
| L      | Blu    |
| L      | Verde  |
| XL     | Rosso  |
| XL     | Blu    |
| XL     | Verde  |
+--------+--------+</pre>
        </div>

        <h3>1.3 Casi d'Uso di CROSS JOIN</h3>

        <div class="codice">
<pre>-- Generare un calendario con tutte le combinazioni anno-mese
SELECT anno, mese 
FROM (SELECT 2024 AS anno UNION SELECT 2025) anni
CROSS JOIN (
    SELECT 1 AS mese UNION SELECT 2 UNION SELECT 3 UNION SELECT 4 
    UNION SELECT 5 UNION SELECT 6 UNION SELECT 7 UNION SELECT 8
    UNION SELECT 9 UNION SELECT 10 UNION SELECT 11 UNION SELECT 12
) mesi
ORDER BY anno, mese;

-- Generare tutte le combinazioni prodotto-negozio per inventario
SELECT p.nome AS prodotto, n.nome AS negozio, 0 AS quantita_iniziale
FROM prodotti p
CROSS JOIN negozi n;</pre>
        </div>

        <h2>2. SELF JOIN</h2>
        
        <div class="teoria">
            <p><strong>SELF JOIN</strong> è una join in cui una tabella viene unita a <strong>se stessa</strong>. È utile quando i dati in una tabella hanno relazioni gerarchiche o quando vuoi confrontare righe nella stessa tabella.</p>
            <p>Per fare una SELF JOIN, devi usare <strong>alias diversi</strong> per la stessa tabella.</p>
        </div>

        <h3>2.1 Sintassi</h3>

        <div class="codice">
<pre>SELECT colonne
FROM tabella T1, tabella T2
WHERE condizione;

-- Oppure con sintassi JOIN esplicita:
SELECT colonne
FROM tabella T1
INNER JOIN tabella T2 ON T1.colonna = T2.colonna;</pre>
        </div>

        <h3>2.2 Esempio: Dipendenti e Manager</h3>

        <div class="codice">
<pre>-- Tabella dipendenti con relazione gerarchica
CREATE TABLE dipendenti (
    id INT PRIMARY KEY AUTO_INCREMENT,
    nome VARCHAR(100),
    ruolo VARCHAR(50),
    manager_id INT,
    FOREIGN KEY (manager_id) REFERENCES dipendenti(id)
);

INSERT INTO dipendenti (nome, ruolo, manager_id) VALUES
('Marco CEO', 'CEO', NULL),
('Luigi Dir', 'Direttore', 1),
('Paolo Dir', 'Direttore', 1),
('Anna Resp', 'Responsabile', 2),
('Maria Resp', 'Responsabile', 2),
('Luca Dev', 'Developer', 4);

-- SELF JOIN: trovare ogni dipendente con il suo manager
SELECT 
    d.nome AS dipendente,
    d.ruolo AS ruolo_dipendente,
    m.nome AS manager,
    m.ruolo AS ruolo_manager
FROM dipendenti d
LEFT JOIN dipendenti m ON d.manager_id = m.id;</pre>
        </div>

        <div class="anteprima">
            <p><strong>Risultato:</strong></p>
            <pre>+------------+------------------+-----------+---------------+
| dipendente | ruolo_dipendente | manager   | ruolo_manager |
+------------+------------------+-----------+---------------+
| Marco CEO  | CEO              | NULL      | NULL          |
| Luigi Dir  | Direttore        | Marco CEO | CEO           |
| Paolo Dir  | Direttore        | Marco CEO | CEO           |
| Anna Resp  | Responsabile     | Luigi Dir | Direttore     |
| Maria Resp | Responsabile     | Luigi Dir | Direttore     |
| Luca Dev   | Developer        | Anna Resp | Responsabile  |
+------------+------------------+-----------+---------------+</pre>
        </div>

        <h3>2.3 Trovare Colleghi nella Stessa Città</h3>

        <div class="codice">
<pre>-- Clienti nella stessa città
SELECT 
    c1.nome AS cliente1,
    c2.nome AS cliente2,
    c1.citta
FROM clienti c1
INNER JOIN clienti c2 
    ON c1.citta = c2.citta 
    AND c1.id < c2.id  -- Evita duplicati e self-match
ORDER BY c1.citta;</pre>
        </div>

        <div class="anteprima">
            <p><strong>Risultato:</strong></p>
            <pre>+-------------+-------------+--------+
| cliente1    | cliente2    | citta  |
+-------------+-------------+--------+
| Mario Rossi | Anna Neri   | Milano |
+-------------+-------------+--------+</pre>
        </div>

        <h3>2.4 Confrontare Prodotti nella Stessa Categoria</h3>

        <div class="codice">
<pre>-- Prodotti più costosi nella stessa categoria
SELECT 
    p1.nome AS prodotto,
    p1.prezzo,
    p1.categoria,
    p2.nome AS prodotto_piu_caro,
    p2.prezzo AS prezzo_maggiore
FROM prodotti p1
INNER JOIN prodotti p2 
    ON p1.categoria = p2.categoria 
    AND p1.prezzo < p2.prezzo
ORDER BY p1.categoria, p1.prezzo;</pre>
        </div>

        <h2>3. Esempio Finale</h2>

        <div class="esempio">
            <h4>Esempio: Organigramma aziendale completo</h4>

            <div class="codice">
<pre>-- Report: Organigramma con livelli gerarchici
SELECT 
    d.nome AS dipendente,
    d.ruolo,
    COALESCE(m.nome, '(Nessuno - Top Level)') AS riporta_a,
    (
        SELECT COUNT(*) 
        FROM dipendenti sub 
        WHERE sub.manager_id = d.id
    ) AS numero_subordinati,
    CASE 
        WHEN d.manager_id IS NULL THEN 'Livello 1 - Executive'
        WHEN m.manager_id IS NULL THEN 'Livello 2 - Management'
        ELSE 'Livello 3+ - Operativo'
    END AS livello_org
FROM dipendenti d
LEFT JOIN dipendenti m ON d.manager_id = m.id
ORDER BY 
    CASE WHEN d.manager_id IS NULL THEN 0 ELSE 1 END,
    d.manager_id,
    d.nome;</pre>
            </div>

            <p><strong>Risultato:</strong></p>
            <pre>+------------+--------------+-------------------------+--------------------+------------------------+
| dipendente | ruolo        | riporta_a               | numero_subordinati | livello_org            |
+------------+--------------+-------------------------+--------------------+------------------------+
| Marco CEO  | CEO          | (Nessuno - Top Level)   |                  2 | Livello 1 - Executive  |
| Luigi Dir  | Direttore    | Marco CEO               |                  2 | Livello 2 - Management |
| Paolo Dir  | Direttore    | Marco CEO               |                  0 | Livello 2 - Management |
| Anna Resp  | Responsabile | Luigi Dir               |                  1 | Livello 3+ - Operativo |
| Maria Resp | Responsabile | Luigi Dir               |                  0 | Livello 3+ - Operativo |
| Luca Dev   | Developer    | Anna Resp               |                  0 | Livello 3+ - Operativo |
+------------+--------------+-------------------------+--------------------+------------------------+</pre>
        </div>

        <div class="nav">
            <a href="lezione-12-2.html" class="btn-prev">Indietro</a>
            <a href="/corso-mysql/index.html" class="btn-home">Indice Corso</a>
            <a href="/corso-mysql/lezione-13/index.html" class="btn-next">Avanti</a>
        </div>

    </div>
</body>
</html>
