<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lezione 13.2 - EXISTS e Subquery nel SELECT/FROM</title>
    <link rel="stylesheet" href="/style.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Lezione 13.2 - EXISTS e Subquery nel SELECT/FROM</h1>
            <p>Controllo esistenza e tabelle derivate</p>
        </div>

        <h2>1. Operatore EXISTS</h2>
        
        <div class="teoria">
            <p>L'operatore <strong>EXISTS</strong> verifica se una subquery restituisce almeno una riga. Restituisce TRUE se la subquery produce risultati, FALSE altrimenti. È molto efficiente perché si ferma appena trova la prima corrispondenza.</p>
        </div>

        <h3>1.1 Sintassi</h3>

        <div class="codice">
<pre>SELECT colonne
FROM tabella
WHERE EXISTS (SELECT 1 FROM altra_tabella WHERE condizione);</pre>
        </div>

        <h3>1.2 EXISTS vs IN</h3>

        <div class="codice">
<pre>-- Clienti con almeno un ordine (usando EXISTS)
SELECT c.nome, c.email
FROM clienti c
WHERE EXISTS (
    SELECT 1 
    FROM ordini o 
    WHERE o.cliente_id = c.id
);

-- Stesso risultato con IN (meno efficiente su grandi dataset)
SELECT nome, email
FROM clienti
WHERE id IN (SELECT cliente_id FROM ordini);

-- Fornitori con prodotti a prezzo < 20
SELECT s.nome AS fornitore
FROM fornitori s
WHERE EXISTS (
    SELECT 1 
    FROM prodotti p 
    WHERE p.fornitore_id = s.id 
    AND p.prezzo < 20
);</pre>
        </div>

        <h3>1.3 NOT EXISTS</h3>

        <div class="codice">
<pre>-- Clienti che NON hanno mai ordinato
SELECT c.nome, c.email
FROM clienti c
WHERE NOT EXISTS (
    SELECT 1 
    FROM ordini o 
    WHERE o.cliente_id = c.id
);

-- Prodotti mai venduti
SELECT p.nome, p.prezzo
FROM prodotti p
WHERE NOT EXISTS (
    SELECT 1 
    FROM dettagli_ordine d 
    WHERE d.prodotto_id = p.id
);

-- Categorie senza prodotti
SELECT cat.nome
FROM categorie cat
WHERE NOT EXISTS (
    SELECT 1 
    FROM prodotti p 
    WHERE p.categoria_id = cat.id
);</pre>
        </div>

        <h2>2. Subquery nel SELECT (Scalar Subquery)</h2>

        <div class="teoria">
            <p>Una <strong>scalar subquery</strong> nel SELECT restituisce un singolo valore per ogni riga della query principale. È utile per aggiungere colonne calcolate basate su altre tabelle.</p>
        </div>

        <div class="codice">
<pre>-- Clienti con conteggio ordini come colonna aggiuntiva
SELECT 
    c.nome,
    c.email,
    (SELECT COUNT(*) FROM ordini o WHERE o.cliente_id = c.id) AS num_ordini,
    (SELECT SUM(importo) FROM ordini o WHERE o.cliente_id = c.id) AS totale_speso
FROM clienti c;

-- Prodotti con quantità in stock e quantità venduta
SELECT 
    p.nome,
    p.prezzo,
    p.stock,
    (SELECT COALESCE(SUM(d.quantita), 0) 
     FROM dettagli_ordine d 
     WHERE d.prodotto_id = p.id) AS quantita_venduta
FROM prodotti p;</pre>
        </div>

        <div class="anteprima">
            <p><strong>Risultato (clienti con ordini):</strong></p>
            <pre>+----------------+-------------------+------------+--------------+
| nome           | email             | num_ordini | totale_speso |
+----------------+-------------------+------------+--------------+
| Mario Rossi    | mario@email.it    |          2 |       929.98 |
| Laura Bianchi  | laura@email.it    |          1 |       349.99 |
| Giuseppe Verdi | giuseppe@email.it |          1 |       129.99 |
| Anna Neri      | anna@email.it     |          0 |         NULL |
+----------------+-------------------+------------+--------------+</pre>
        </div>

        <h2>3. Subquery nel FROM (Derived Tables)</h2>

        <div class="teoria">
            <p>Una subquery nel FROM crea una <strong>tabella derivata</strong> (o tabella temporanea) che può essere usata come qualsiasi altra tabella nella query principale. Deve sempre avere un alias.</p>
        </div>

        <div class="codice">
<pre>-- Statistiche ordini per cliente (tabella derivata)
SELECT 
    stats.nome,
    stats.num_ordini,
    stats.totale_speso,
    stats.media_ordine
FROM (
    SELECT 
        c.nome,
        COUNT(o.id) AS num_ordini,
        SUM(o.importo) AS totale_speso,
        AVG(o.importo) AS media_ordine
    FROM clienti c
    LEFT JOIN ordini o ON c.id = o.cliente_id
    GROUP BY c.id, c.nome
) AS stats
WHERE stats.num_ordini > 0
ORDER BY stats.totale_speso DESC;

-- Top 3 categorie per vendite
SELECT * FROM (
    SELECT 
        cat.nome AS categoria,
        COUNT(d.id) AS prodotti_venduti,
        SUM(d.quantita * p.prezzo) AS ricavo_totale
    FROM categorie cat
    JOIN prodotti p ON cat.id = p.categoria_id
    JOIN dettagli_ordine d ON p.id = d.prodotto_id
    GROUP BY cat.id, cat.nome
    ORDER BY ricavo_totale DESC
    LIMIT 3
) AS top_categorie;</pre>
        </div>

        <h2>4. Subquery con INSERT, UPDATE, DELETE</h2>

        <div class="codice">
<pre>-- INSERT con subquery
INSERT INTO clienti_vip (cliente_id, data_promozione)
SELECT id, CURDATE()
FROM clienti
WHERE id IN (
    SELECT cliente_id 
    FROM ordini 
    GROUP BY cliente_id 
    HAVING SUM(importo) > 1000
);

-- UPDATE con subquery
UPDATE prodotti
SET prezzo = prezzo * 0.9  -- Sconto 10%
WHERE id IN (
    SELECT prodotto_id 
    FROM dettagli_ordine 
    GROUP BY prodotto_id 
    HAVING SUM(quantita) < 5
);

-- DELETE con subquery
DELETE FROM clienti
WHERE id NOT IN (SELECT DISTINCT cliente_id FROM ordini)
AND data_registrazione < DATE_SUB(CURDATE(), INTERVAL 1 YEAR);</pre>
        </div>

        <h2>5. Esempio Finale</h2>

        <div class="esempio">
            <h4>Esempio: Dashboard vendite completa</h4>

            <div class="codice">
<pre>-- Report completo con subquery multiple
SELECT 
    c.nome AS cliente,
    c.citta,
    -- Subquery per conteggio ordini
    (SELECT COUNT(*) FROM ordini o WHERE o.cliente_id = c.id) AS ordini_effettuati,
    -- Subquery per totale speso
    (SELECT COALESCE(SUM(importo), 0) FROM ordini o WHERE o.cliente_id = c.id) AS totale_speso,
    -- Subquery per ultimo ordine
    (SELECT MAX(data_ordine) FROM ordini o WHERE o.cliente_id = c.id) AS ultimo_ordine,
    -- Classificazione basata su subquery nel FROM
    CASE 
        WHEN (SELECT SUM(importo) FROM ordini o WHERE o.cliente_id = c.id) >= 
             (SELECT AVG(totale) FROM (
                 SELECT SUM(importo) AS totale 
                 FROM ordini 
                 GROUP BY cliente_id
             ) AS medie) * 1.5 
        THEN 'VIP'
        WHEN EXISTS (SELECT 1 FROM ordini o WHERE o.cliente_id = c.id) 
        THEN 'Attivo'
        ELSE 'Nuovo'
    END AS categoria_cliente
FROM clienti c
ORDER BY totale_speso DESC;</pre>
            </div>

            <p><strong>Risultato:</strong></p>
            <pre>+----------------+--------+-------------------+--------------+---------------+-------------------+
| cliente        | citta  | ordini_effettuati | totale_speso | ultimo_ordine | categoria_cliente |
+----------------+--------+-------------------+--------------+---------------+-------------------+
| Mario Rossi    | Milano |                 2 |       929.98 | 2024-01-20    | VIP               |
| Laura Bianchi  | Roma   |                 1 |       349.99 | 2024-02-10    | Attivo            |
| Giuseppe Verdi | Napoli |                 1 |       129.99 | 2024-02-15    | Attivo            |
| Anna Neri      | Milano |                 0 |         0.00 | NULL          | Nuovo             |
+----------------+--------+-------------------+--------------+---------------+-------------------+</pre>
        </div>

        <div class="nav">
            <a href="lezione-13-1.html" class="btn-prev">Indietro</a>
            <a href="/corso-mysql/index.html" class="btn-home">Indice Corso</a>
            <a href="/corso-mysql/lezione-14/index.html" class="btn-next">Avanti</a>
        </div>

    </div>
</body>
</html>
